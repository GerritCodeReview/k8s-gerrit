{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "dde744d0_bc6f8fed",
        "filename": "Documentation/examples/gerritcluster-3-nodes-pr-kafka-multisite.yaml",
        "patchSetId": 25
      },
      "lineNbr": 150,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "nit: empty line before this line for readability and consistency.",
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "76d3c0f1_f388927d",
        "filename": "Documentation/examples/gerritcluster-3-nodes-pr-kafka-multisite.yaml",
        "patchSetId": 25
      },
      "lineNbr": 150,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-06T16:34:58Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "dde744d0_bc6f8fed",
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c7d683c1_7fc39aad",
        "filename": "Documentation/examples/gerritcluster-3-nodes-pr-kafka-multisite.yaml",
        "patchSetId": 25
      },
      "lineNbr": 159,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "Considering the semantics, this might be something that is happening on the cluster level, i.e. even if we support sharding at some point, all primary Gerrit instances would use the same topics. So you might consider managing these configurations on GerritCluster level.",
      "range": {
        "startLine": 155,
        "startChar": 0,
        "endLine": 159,
        "endChar": 53
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4468d335_03a2b266",
        "filename": "Documentation/examples/gerritcluster-3-nodes-pr-kafka-multisite.yaml",
        "patchSetId": 25
      },
      "lineNbr": 159,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-04T16:55:58Z",
      "side": 1,
      "message": "I believe that there is space for improvement in the way that we configure multisite plugin and we will address this in a followup change.\n\n\u003e  i.e. even if we support sharding at some point, all primary Gerrit instances would use the same topics. So you might consider managing these configurations on GerritCluster level.\n\nI believe that is a future feature and it is not related with the multisite setup. Whenever we have the requirement we can address it.",
      "parentUuid": "c7d683c1_7fc39aad",
      "range": {
        "startLine": 155,
        "startChar": 0,
        "endLine": 159,
        "endChar": 53
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "93636ead_1bbc5a3b",
        "filename": "container-images/gerrit-init/tools/gerrit-initializer/initializer/tasks/pull_replication_configurator.py",
        "patchSetId": 25
      },
      "lineNbr": 52,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "As already stated in a previous change, this should not be required.",
      "range": {
        "startLine": 52,
        "startChar": 8,
        "endLine": 52,
        "endChar": 88
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "da4c8ca3_5c8cc584",
        "filename": "container-images/gerrit-init/tools/gerrit-initializer/initializer/tasks/pull_replication_configurator.py",
        "patchSetId": 25
      },
      "lineNbr": 128,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "There should be no need for that.",
      "range": {
        "startLine": 124,
        "startChar": 0,
        "endLine": 128,
        "endChar": 60
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "35510148_d6e519c2",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/api/model/gerrit/GerritTemplate.java",
        "patchSetId": 25
      },
      "lineNbr": 87,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "Should not be required. Otherwise HA would also fail.",
      "range": {
        "startLine": 87,
        "startChar": 8,
        "endLine": 87,
        "endChar": 68
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "338725e6_c4ce2ce9",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/api/model/gerrit/GerritTemplate.java",
        "patchSetId": 25
      },
      "lineNbr": 87,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-06T16:34:58Z",
      "side": 1,
      "message": "Why would that fail? This code is introducing the logical operator `OR` and for that reason it would not affect.",
      "parentUuid": "35510148_d6e519c2",
      "range": {
        "startLine": 87,
        "startChar": 8,
        "endLine": 87,
        "endChar": 68
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68e2b9a3_f1065358",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 99,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "Isn\u0027t that required for multisite as well?",
      "range": {
        "startLine": 99,
        "startChar": 22,
        "endLine": 99,
        "endChar": 78
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53785526_9f34335e",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 99,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-06T16:34:58Z",
      "side": 1,
      "message": "Good question, when we added it, it blew up. Let us double check again to try to understand the reason.",
      "parentUuid": "68e2b9a3_f1065358",
      "range": {
        "startLine": 99,
        "startChar": 22,
        "endLine": 99,
        "endChar": 78
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "156c9bdb_179e9645",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 211,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "unrelated change",
      "range": {
        "startLine": 211,
        "startChar": 87,
        "endLine": 211,
        "endChar": 88
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "19701e17_00292fea",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 211,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-04T16:55:58Z",
      "side": 1,
      "message": "This comment [1] explains the reason why the value 7 is needed.\n\nReference:\n[1] https://gerrit-review.googlesource.com/c/k8s-gerrit/+/425526/11/operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java#198",
      "parentUuid": "156c9bdb_179e9645",
      "range": {
        "startLine": 211,
        "startChar": 87,
        "endLine": 211,
        "endChar": 88
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6b2fe8c9_1cee4440",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 223,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "Why change that?",
      "range": {
        "startLine": 223,
        "startChar": 84,
        "endLine": 223,
        "endChar": 89
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f1001b46_6520b045",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 223,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-04T16:55:58Z",
      "side": 1,
      "message": "Good question, the reason is because when multisite plugin is installed, the plugin itself has a producer of stream events (to `gerrit` topic) and for that reason you dont need `events-kafka` plugin to send duplicated stream events to Kafka (by default `gerrit` topic) again [1].\n\nProbably we could remove this line to avoid confusion.\n\nReferences:\n[1] https://gerrit.googlesource.com/plugins/events-kafka/+/refs/heads/stable-3.9/src/main/resources/Documentation/config.md",
      "parentUuid": "6b2fe8c9_1cee4440",
      "range": {
        "startLine": 223,
        "startChar": 84,
        "endLine": 223,
        "endChar": 89
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "153b6908_da42f8f8",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 226,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2024-05-24T10:44:04Z",
      "side": 1,
      "message": "Why not use the default, which according to the documentation is anyway the instance ID?",
      "range": {
        "startLine": 224,
        "startChar": 6,
        "endLine": 226,
        "endChar": 76
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "08f6b04d_79655ba2",
        "filename": "operator/src/main/java/com/google/gerrit/k8s/operator/gerrit/config/GerritConfigBuilder.java",
        "patchSetId": 25
      },
      "lineNbr": 226,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2024-06-06T17:58:35Z",
      "side": 1,
      "message": "This is a really good point. \n\nIf we dont defined explicitly the property `groupId` in the `events-kafka` section, the `multisite` and `websession-broker` plugins fail in lading time when Gerrit starts with the following exception:\n```\n[2024-06-06T17:16:35.319Z] [main] WARN  com.google.gerrit.server.plugins.PluginLoader : Cannot load plugin multi-site\norg.apache.kafka.common.KafkaException: Failed to construct kafka consumer\n\tat org.apache.kafka.clients.consumer.KafkaConsumer.\u003cinit\u003e(KafkaConsumer.java:827)\n\tat org.apache.kafka.clients.consumer.KafkaConsumer.\u003cinit\u003e(KafkaConsumer.java:664)\n\tat com.googlesource.gerrit.plugins.kafka.subscribe.KafkaConsumerFactory.create(KafkaConsumerFactory.java:40)\n\tat com.googlesource.gerrit.plugins.kafka.subscribe.KafkaEventNativeSubscriber.subscribe(KafkaEventNativeSubscriber.java:90)\n\tat com.googlesource.gerrit.plugins.kafka.api.KafkaBrokerApi.receiveAsync(KafkaBrokerApi.java:102)\n\tat com.googlesource.gerrit.plugins.kafka.api.KafkaBrokerApi.receiveAsync(KafkaBrokerApi.java:53)\n\tat com.googlesource.gerrit.plugins.multisite.consumer.MultiSiteConsumerRunner.lambda$start$0(MultiSiteConsumerRunner.java:49)\n\tat java.base/java.lang.Iterable.forEach(Iterable.java:75)\n\tat com.googlesource.gerrit.plugins.multisite.consumer.MultiSiteConsumerRunner.start(MultiSiteConsumerRunner.java:47)\n\tat com.google.gerrit.lifecycle.LifecycleManager.start(LifecycleManager.java:95)\n\tat com.google.gerrit.server.plugins.ServerPlugin.startPlugin(ServerPlugin.java:274)\n\tat com.google.gerrit.server.plugins.ServerPlugin.start(ServerPlugin.java:196)\n\tat com.google.gerrit.server.plugins.PluginLoader.runPlugin(PluginLoader.java:555)\n\tat com.google.gerrit.server.plugins.PluginLoader.rescan(PluginLoader.java:441)\n\tat com.google.gerrit.server.plugins.PluginLoader.start(PluginLoader.java:341)\n\tat com.google.gerrit.lifecycle.LifecycleManager.start(LifecycleManager.java:95)\n\tat com.google.gerrit.pgm.Daemon.start(Daemon.java:404)\n\tat com.google.gerrit.pgm.Daemon.run(Daemon.java:297)\n\tat com.google.gerrit.pgm.util.AbstractProgram.main(AbstractProgram.java:62)\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\n\tat com.google.gerrit.launcher.GerritLauncher.invokeProgram(GerritLauncher.java:252)\n\tat com.google.gerrit.launcher.GerritLauncher.mainImpl(GerritLauncher.java:148)\n\tat com.google.gerrit.launcher.GerritLauncher.main(GerritLauncher.java:93)\n\tat Main.main(Main.java:30)\nCaused by: org.apache.kafka.common.errors.InvalidConfigurationException: enable.auto.commit cannot be set to true when default group id (null) is used.\n```\n\nFrom the stack trace we can see that the Kafka consumer property `group.id` is `null` and is not set as the documentation is suggesting with the default value [1]\n\n\nReferences: \n[1] https://gerrit.googlesource.com/k8s-gerrit/+/refs/heads/master/container-images/gerrit/tools/start#26",
      "parentUuid": "153b6908_da42f8f8",
      "range": {
        "startLine": 224,
        "startChar": 6,
        "endLine": 226,
        "endChar": 76
      },
      "revId": "7e49068ee2d53180323fc903467f104e4b38be73",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}