#!/bin/bash

symlink_config_to_site(){
    mkdir -p /var/gerrit/etc
    for file in /var/mnt/etc/config/* /var/mnt/etc/secret/*; do
        ln -sf $file /var/gerrit/etc/$(basename $file)
    done
}

# Ensure that configuration provided at /var/mnt/config and /var/mnt/secret
# is symlinked to the Gerrit site. This is necessary, because mounting files
# from secrets/configmaps in Kubernetes make the containing directory read-only.
symlink_config_to_site

java -jar /var/gerrit/bin/gerrit.war reindex \
    -d /var/gerrit

/var/gerrit/bin/gerrit.sh start
tail -F -n +1 /var/gerrit/logs/{error,httpd,sshd}_log
